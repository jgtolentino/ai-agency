---
name: Blue-Green Deployment

# Trigger on manual dispatch or successful CI builds
on:
  workflow_dispatch:
    inputs:
      target_version:
        description: 'Odoo version to deploy (e.g., 17.0, 19.0)'
        required: true
        default: '17.0'
      deployment_strategy:
        description: 'Deployment strategy'
        required: true
        default: 'blue-green'
        type: choice
        options:
          - blue-green
          - canary
      skip_health_checks:
        description: 'Skip health checks (not recommended)'
        required: false
        type: boolean
        default: false
      auto_switch:
        description: 'Automatically switch traffic after health checks'
        required: false
        type: boolean
        default: false

  # Trigger on successful CI completion (optional)
  workflow_run:
    workflows: ["odoo-expertise-ci"]
    types:
      - completed
    branches: [main]

env:
  DOCKER_REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/odoo
  ODOO_VERSION: ${{ inputs.target_version || '17.0' }}

jobs:
  # =============================================================================
  # Job 1: Build and Push Docker Image
  # =============================================================================
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
      image_digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=${{ env.ODOO_VERSION }}
            type=sha,prefix=${{ env.ODOO_VERSION }}-
            type=ref,event=branch
            type=semver,pattern={{version}}

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            ODOO_VERSION=${{ env.ODOO_VERSION }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Image build summary
        run: |
          echo "### Docker Image Built âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tags:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "**Digest:** ${{ steps.build.outputs.digest }}" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Job 2: Deploy to Green Environment
  # =============================================================================
  deploy-green:
    name: Deploy to Green Environment
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: green-staging
      url: http://green.odoo.example.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      - name: Pull Docker image on server
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
            "docker pull ${{ needs.build.outputs.image_tag }}"

      - name: Deploy green environment
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
            set -e

            # Set environment variables
            export GREEN_IMAGE="${{ needs.build.outputs.image_tag }}"
            export GREEN_VERSION="${{ env.ODOO_VERSION }}"

            # Stop existing green environment
            docker-compose -f /opt/odoo/docker-compose.blue-green.yml \
              stop odoo-green || true

            # Remove old green container
            docker-compose -f /opt/odoo/docker-compose.blue-green.yml \
              rm -f odoo-green || true

            # Start new green environment
            docker-compose -f /opt/odoo/docker-compose.blue-green.yml \
              --profile deployment up -d odoo-green

            # Wait for green to start
            echo "Waiting for green environment to start..."
            sleep 30
          EOF

      - name: Verify green deployment
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
            "docker-compose -f /opt/odoo/docker-compose.blue-green.yml ps odoo-green"

      - name: Deployment summary
        run: |
          echo "### Green Environment Deployed âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** ${{ needs.build.outputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ env.ODOO_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** green-staging" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Job 3: Health Checks
  # =============================================================================
  health-checks:
    name: Run Health Checks
    runs-on: ubuntu-latest
    needs: deploy-green
    if: ${{ !inputs.skip_health_checks }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      - name: Copy health check script to server
        run: |
          scp -i ~/.ssh/deploy_key scripts/health_check.py \
            ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:/tmp/health_check.py

      - name: Run basic health checks
        id: health_basic
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
            "python3 /tmp/health_check.py --target green --json" > health_results.json

          # Parse results
          HEALTH_STATUS=$(jq -r '.status' health_results.json)
          echo "health_status=$HEALTH_STATUS" >> $GITHUB_OUTPUT

          if [ "$HEALTH_STATUS" != "healthy" ]; then
            echo "âŒ Health checks failed"
            cat health_results.json
            exit 1
          fi

      - name: Run comprehensive health checks
        id: health_comprehensive
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
            "python3 /tmp/health_check.py --target green --comprehensive --json" > health_comprehensive.json

          # Parse results
          HEALTH_STATUS=$(jq -r '.status' health_comprehensive.json)
          TOTAL_CHECKS=$(jq '.checks | length' health_comprehensive.json)
          HEALTHY_CHECKS=$(jq '[.checks[] | select(.status == "healthy")] | length' health_comprehensive.json)

          echo "total_checks=$TOTAL_CHECKS" >> $GITHUB_OUTPUT
          echo "healthy_checks=$HEALTHY_CHECKS" >> $GITHUB_OUTPUT

          if [ "$HEALTH_STATUS" != "healthy" ]; then
            echo "âŒ Comprehensive health checks failed"
            cat health_comprehensive.json
            exit 1
          fi

      - name: Upload health check results
        uses: actions/upload-artifact@v4
        with:
          name: health-check-results
          path: health_*.json
          retention-days: 30

      - name: Health check summary
        run: |
          echo "### Health Checks Passed âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total Checks:** ${{ steps.health_comprehensive.outputs.total_checks }}" >> $GITHUB_STEP_SUMMARY
          echo "**Passed:** ${{ steps.health_comprehensive.outputs.healthy_checks }}" >> $GITHUB_STEP_SUMMARY
          echo "**Failed:** 0" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          cat health_comprehensive.json >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Job 4: Smoke Tests
  # =============================================================================
  smoke-tests:
    name: Run Smoke Tests
    runs-on: ubuntu-latest
    needs: health-checks

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      - name: Test login endpoint
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
            "curl -f http://localhost:9069/web/login"

      - name: Test database manager
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
            "curl -f http://localhost:9069/web/database/manager"

      - name: Test static resources
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
            "curl -f http://localhost:9069/web/static/src/css/web.css"

      - name: Smoke test summary
        run: |
          echo "### Smoke Tests Passed âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Login endpoint: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- Database manager: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- Static resources: âœ…" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Job 5: Traffic Switch (Manual or Auto)
  # =============================================================================
  traffic-switch:
    name: Switch Traffic to Green
    runs-on: ubuntu-latest
    needs: [health-checks, smoke-tests]
    if: ${{ inputs.auto_switch }}
    environment:
      name: production
      url: https://odoo.example.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      - name: Switch traffic to green
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
            set -e

            echo "ðŸ”„ Switching traffic to green environment..."

            # Update Nginx configuration
            sed -i 's/server odoo-blue:8069;/server odoo-green:8069;/' \
              /opt/odoo/nginx/conf.d/odoo.conf

            # Reload Nginx
            docker-compose -f /opt/odoo/docker-compose.blue-green.yml \
              exec nginx nginx -s reload

            # Verify routing
            sleep 5
            curl -I http://localhost | grep -i "server"

            echo "âœ… Traffic switched to green environment"
          EOF

      - name: Verify production traffic
        run: |
          # Wait for DNS propagation
          sleep 10

          # Test production URL
          curl -f https://odoo.example.com/web/health

      - name: Traffic switch summary
        run: |
          echo "### Traffic Switched to Green âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Production traffic now on green environment" >> $GITHUB_STEP_SUMMARY
          echo "**Blue Status:** Standby (rollback target)" >> $GITHUB_STEP_SUMMARY
          echo "**Monitoring:** 30-minute validation window" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Job 6: Post-Deployment Monitoring
  # =============================================================================
  monitoring:
    name: Post-Deployment Monitoring
    runs-on: ubuntu-latest
    needs: traffic-switch
    if: ${{ inputs.auto_switch }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      - name: Monitor green environment (5 minutes)
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
            set -e

            echo "ðŸ“Š Monitoring green environment for 5 minutes..."

            for i in {1..10}; do
              echo "Check $i/10..."

              # Health check
              if ! curl -sf http://localhost:9069/web/health; then
                echo "âŒ Health check failed, initiating rollback"
                bash /opt/odoo/scripts/rollback_to_blue.sh
                exit 1
              fi

              # Check error rate
              ERROR_COUNT=$(docker-compose -f /opt/odoo/docker-compose.blue-green.yml \
                logs --tail=100 odoo-green | grep -c "ERROR" || true)

              if [ "$ERROR_COUNT" -gt 5 ]; then
                echo "âš ï¸  High error count detected: $ERROR_COUNT"
              fi

              sleep 30
            done

            echo "âœ… Monitoring complete, green environment stable"
          EOF

      - name: Monitoring summary
        run: |
          echo "### Monitoring Complete âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Duration:** 5 minutes" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Green environment stable" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:** Extended monitoring via Grafana" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Job 7: Rollback (On Failure)
  # =============================================================================
  rollback:
    name: Rollback to Blue
    runs-on: ubuntu-latest
    needs: [deploy-green, health-checks, smoke-tests, traffic-switch, monitoring]
    if: failure()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      - name: Execute rollback
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
            "bash /opt/odoo/scripts/rollback_to_blue.sh"

      - name: Verify blue environment
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
            "python3 /tmp/health_check.py --target blue --comprehensive"

      - name: Rollback summary
        run: |
          echo "### Rollback Executed âš ï¸" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Traffic restored to blue environment" >> $GITHUB_STEP_SUMMARY
          echo "**Reason:** Deployment validation failed" >> $GITHUB_STEP_SUMMARY
          echo "**Action Required:** Investigate green environment issues" >> $GITHUB_STEP_SUMMARY

      - name: Send rollback notification
        uses: slackapi/slack-github-action@v1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": "ðŸš¨ Deployment Rollback Executed",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "Deployment Rollback"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Status:* Traffic restored to blue environment\n*Reason:* Deployment validation failed\n*Repository:* ${{ github.repository }}\n*Workflow:* ${{ github.workflow }}"
                  }
                }
              ]
            }
        if: always()

  # =============================================================================
  # Job 8: Deployment Summary
  # =============================================================================
  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [build, deploy-green, health-checks, smoke-tests, traffic-switch, monitoring]
    if: success()

    steps:
      - name: Generate deployment report
        run: |
          echo "# Deployment Summary âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ env.ODOO_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image:** ${{ needs.build.outputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Strategy:** ${{ inputs.deployment_strategy }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Auto-Switch:** ${{ inputs.auto_switch }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Status" >> $GITHUB_STEP_SUMMARY
          echo "- Build: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- Deploy Green: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- Health Checks: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- Smoke Tests: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- Traffic Switch: ${{ inputs.auto_switch && 'âœ…' || 'â¸ï¸ Manual' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Monitoring: ${{ inputs.auto_switch && 'âœ…' || 'â¸ï¸ Pending' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Next Steps" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.auto_switch }}" == "true" ]; then
            echo "- Monitor green environment in Grafana" >> $GITHUB_STEP_SUMMARY
            echo "- Review deployment logs" >> $GITHUB_STEP_SUMMARY
            echo "- Decommission blue environment after 24-48h" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Review health check results" >> $GITHUB_STEP_SUMMARY
            echo "- Manually switch traffic when ready" >> $GITHUB_STEP_SUMMARY
            echo "- Run: \`bash scripts/switch_to_green.sh\`" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Send success notification
        uses: slackapi/slack-github-action@v1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": "âœ… Deployment Successful",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "Deployment Successful"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Version:* ${{ env.ODOO_VERSION }}\n*Environment:* green â†’ production\n*Repository:* ${{ github.repository }}\n*Workflow:* ${{ github.workflow }}"
                  }
                }
              ]
            }
        if: always()
